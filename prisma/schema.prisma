generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Session {
  id                  String    @id
  shop                String
  state               String
  isOnline            Boolean   @default(false)
  scope               String?
  expires             DateTime?
  accessToken         String
  userId              BigInt?
  firstName           String?
  lastName            String?
  email               String?
  accountOwner        Boolean   @default(false)
  locale              String?
  collaborator        Boolean?  @default(false)
  emailVerified       Boolean?  @default(false)
  refreshToken        String?
  refreshTokenExpires DateTime?
}

model Product {
  id             Int              @id @default(autoincrement())
  shop           String
  prodId         String           @unique
  title          String
  description    String?
  tags           String[]
  collection     String[]
  options        Json
  price          Float
  stock          Int
  handle         String?
  image          String?
  isSynced       Boolean          @default(false)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  MessageProduct MessageProduct[]
  faqs           ProductFAQ[]
  variants       ProductVariant[]

  @@index([shop])
}

model ProductVariant {
  id        Int     @id @default(autoincrement())
  title     String
  sku       String
  image     String?
  option    String
  stock     Int
  productId Int
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model ProductFAQ {
  id        String   @id @default(uuid())
  question  String
  answer    String
  productId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id])

  @@index([productId])
}

model ChatSession {
  id         String    @id @default(uuid())
  customerId String?
  isGuest    Boolean   @default(true)
  createdAt  DateTime  @default(now())
  shop       String
  Customer   Customer? @relation(fields: [customerId], references: [id])
  messages   Message[]

  @@index([shop])
  @@index([customerId])
}

model Message {
  id                  String           @id @default(uuid())
  content             String
  role                String
  createdAt           DateTime         @default(now())
  sessionId           String
  ChatSession         ChatSession      @relation(fields: [sessionId], references: [id])
  recommendedProducts MessageProduct[]
}

model MessageProduct {
  id            String   @id @default(uuid())
  messageId     String
  productProdId String?
  title         String
  price         Float
  handle        String?
  image         String?
  score         Float?
  message       Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  Product       Product? @relation(fields: [productProdId], references: [prodId])

  @@index([messageId])
  @@index([productProdId])
}

model MerchantCredits {
  id               String       @id @default(uuid())
  shop             String       @unique
  planId           String
  totalCredits     Int          @default(0)
  usedCredits      Int          @default(0)
  remainingCredits Int          @default(0)
  totalRequests    Int          @default(0)
  totalUsers       Int          @default(0)
  periodStart      DateTime     @default(now())
  periodEnd        DateTime
  aiEnabled        Boolean      @default(true)
  autoRecharge     Boolean      @default(true)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  MerchantPlan     MerchantPlan @relation(fields: [planId], references: [id])
  UsageLog         UsageLog[]

  @@index([planId])
  @@index([shop])
}

model Campaign {
  id              String            @id @default(uuid())
  shop            String
  name            String
  description     String?
  isActive        Boolean           @default(true)
  triggerKeywords String[]
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  products        CampaignProduct[]

  @@index([shop])
}

model CampaignProduct {
  id         String   @id @default(uuid())
  campaignId String
  productId  String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([campaignId, productId])
  @@index([campaignId])
}

model Discount {
  id          String    @id @default(uuid())
  shop        String
  shopifyId   String    @unique
  title       String
  code        String
  startsAt    DateTime
  endsAt      DateTime?
  status      String
  isSuggested Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([shop])
}

model FAQ {
  id        String   @id @default(uuid())
  shop      String
  question  String
  answer    String
  category  String   @default("General")
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([shop])
  @@index([shop, category])
}

model AISettings {
  id        String   @id @default(uuid())
  shop      String   @unique
  settings  Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([shop])
}

model ChatbotCustomization {
  id        String   @id @default(uuid())
  shop      String   @unique
  settings  Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([shop])
}

model ChatConfiguration {
  id                         String   @id @default(uuid())
  shop                       String   @unique
  aiEnabled                  Boolean  @default(true)
  autoHandoffEnabled         Boolean  @default(true)
  useKeywordResponses        Boolean  @default(true)
  discountSuggestionsEnabled Boolean  @default(true)
  maxTokensPerResponse       Int      @default(500)
  maxConcurrentRequests      Int      @default(5)
  rateLimitPerMinute         Int      @default(60)
  fallbackMessage            String?
  manualChatNotification     String?
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt

  @@index([shop])
}

model Customer {
  id          String        @id @default(uuid())
  shopifyId   String?       @unique
  email       String
  firstName   String?
  lastName    String?
  phone       String?
  source      String        @default("SHOPIFY")
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  shop        String
  ChatSession ChatSession[]
  Order       Order[]

  @@unique([shop, email])
  @@index([shop, email])
}

model MerchantPlan {
  id                 String            @id @default(uuid())
  name               String            @unique
  monthlyCredits     Int
  maxConcurrentChats Int
  price              Float
  features           Json
  isActive           Boolean           @default(true)
  createdAt          DateTime          @default(now())
  MerchantCredits    MerchantCredits[]
}

model Order {
  id          String      @id @default(uuid())
  shopifyId   String      @unique
  orderNumber String
  status      String
  totalPrice  Float
  createdAt   DateTime
  customerId  String
  Customer    Customer    @relation(fields: [customerId], references: [id])
  OrderItem   OrderItem[]
}

model OrderItem {
  id          String  @id @default(uuid())
  productName String
  quantity    Int
  sku         String?
  orderId     String
  productId   String
  Order       Order   @relation(fields: [orderId], references: [id])
}

model UsageLog {
  id                String          @id @default(uuid())
  shop              String
  merchantCreditsId String
  requestType       String
  creditsUsed       Int             @default(1)
  sessionId         String?
  customerId        String?
  userMessage       String?
  responseTime      Int?
  tokensUsed        Int?
  wasSuccessful     Boolean         @default(true)
  errorMessage      String?
  createdAt         DateTime        @default(now())
  MerchantCredits   MerchantCredits @relation(fields: [merchantCreditsId], references: [id])

  @@index([merchantCreditsId])
  @@index([requestType])
  @@index([shop, createdAt])
}
